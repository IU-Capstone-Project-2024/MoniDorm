name: Deploy to Remote Server

on:
  push:
    branches:
      - frontend

jobs:
  deploy:
    runs-on: self-hosted

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Build and push Docker image
      env:
        DOCKER_HUB_USERNAME: ${{ secrets.DOCKER_HUB_USERNAME }}
        DOCKER_HUB_PASSWORD: ${{ secrets.DOCKER_HUB_PASSWORD }}
        
      run: |
        cd frontend
        docker build -t frontend-monidorm .
        docker tag frontend-monidorm:latest $DOCKER_HUB_USERNAME/frontend-monidorm:latest
        docker login -u $DOCKER_HUB_USERNAME -p $DOCKER_HUB_PASSWORD
        docker push $DOCKER_HUB_USERNAME/frontend-monidorm:latest

    - name: Deploy to server
      env:
        VM_IP: ${{ secrets.VM_IP }}
        VM_USER: ${{ secrets.VM_USER }}
        DOCKER_HUB_USERNAME: ${{ secrets.DOCKER_HUB_USERNAME }}
      run: |
        ssh $VM_USER@$VM_IP 'docker pull $DOCKER_HUB_USERNAME/frontend-monidorm:latest'
        ssh $VM_USER@$VM_IP 'docker stop frontend-monidorm-container || true'
        ssh $VM_USER@$VM_IP 'docker rm frontend-monidorm-container || true'
        ssh $VM_USER@$VM_IP 'docker run -d --name frontend-monidorm-container -p 80:80 $DOCKER_HUB_USERNAME/frontend-monidorm:latest'
